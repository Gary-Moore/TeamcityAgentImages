version: v1.1.0
stepTimeout: 1200

steps:
- id: build
  build: >-
    --platform linux/amd64
    -t $Registry/teamcity/agent:{{ .Values.image_tag }}
    {{ if .Values.alias_tag1 }} -t $Registry/teamcity/agent:{{ .Values.alias_tag1 }}{{ end }}
    {{ if .Values.alias_tag2 }} -t $Registry/teamcity/agent:{{ .Values.alias_tag2 }}{{ end }}
    --build-arg BASE_IMAGE={{ .Values.base_image }}
    --build-arg ENTRUST_INTERMEDIATE_URL={{ .Values.entrust_url }}
    --build-arg ENTRUST_INTERMEDIATE_SHA256={{ .Values.entrust_sha256 }}
    --build-arg VCS_REF={{ .Run.SourceControlCommit }}
    --build-arg BUILD_DATE={{ .Run.Date }}
    -f docker/linux/az-agent/azagent.dockerfile
    .

- id: smoke
  image: $Registry/teamcity/agent:{{ .Values.image_tag }}
  entryPoint: /bin/bash -lc
  timeout: 1200
  cmd: |
    set -euo pipefail
    echo "=== Smoke start: $(date -u +%FT%TZ) ==="
    /usr/local/bin/test-image.sh
    echo "=== Smoke OK ==="
    echo 'PDS_RUNTIME_JSON: {"smoke":"ok","tag":"{{ .Values.image_tag }}","ts":"{{ .Run.Date }}"}'

- id: push
  push:
    - $Registry/teamcity/agent:{{ .Values.image_tag }}
{{ if .Values.alias_tag1 }}
    - $Registry/teamcity/agent:{{ .Values.alias_tag1 }}
{{ end }}
{{ if .Values.alias_tag2 }}
    - $Registry/teamcity/agent:{{ .Values.alias_tag2 }}
{{ end }}
  when: ["smoke"]
