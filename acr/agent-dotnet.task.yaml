version: v1.1.0
stepTimeout: 1200

steps:
  - id: build
    build: >-
      --platform linux/amd64
      -t $Registry/teamcity/agent:{{ .Values.image_tag }}
      {{ if .Values.alias_tag1 }} -t $Registry/teamcity/agent:{{ .Values.alias_tag1 }}{{ end }}
      {{ if .Values.alias_tag2 }} -t $Registry/teamcity/agent:{{ .Values.alias_tag2 }}{{ end }}
      --build-arg BASE_IMAGE={{ .Values.base_image }}
      --build-arg DOTNET_MAJOR={{ .Values.dotnet_major }}
      --build-arg NODE_MAJOR={{ .Values.node_major }}
      --build-arg ENTRUST_INTERMEDIATE_URL={{ .Values.entrust_url }}
      --build-arg ENTRUST_INTERMEDIATE_SHA256={{ .Values.entrust_sha256 }}
      --build-arg VCS_REF={{ .Run.SourceControlCommit }}
      --build-arg BUILD_DATE={{ .Run.Date }}
      -f docker/linux/dotnet-agent/dotnetagent.dockerfile
      .

  - id: smoke
    cmd: |
      set -euo pipefail
      echo "=== Smoke start: $(date -u +%FT%TZ) ==="
      /usr/local/bin/test-image.sh
      echo "=== Smoke OK ==="
      # Include majors so outer script can enrich manifest easily
      echo 'PDS_RUNTIME_JSON: {"smoke":"ok","tag":"{{ .Values.image_tag }}","dotnet_major":"{{ .Values.dotnet_major }}","node_major":"{{ .Values.node_major }}","ts":"{{ .Run.Date }}"}'
    when: ["build"]

  - id: push
    push:
      - $Registry/teamcity/agent:{{ .Values.image_tag }}
{{ if .Values.alias_tag1 }}
      - $Registry/teamcity/agent:{{ .Values.alias_tag1 }}
{{ end }}
{{ if .Values.alias_tag2 }}
      - $Registry/teamcity/agent:{{ .Values.alias_tag2 }}
{{ end }}
    when: ["smoke"]
