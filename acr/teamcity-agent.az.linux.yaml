version: v1.1.0
stepTimeout: 1200
steps: 
- build: >-
    -t $Registry/teamcity/agent:{{ .Values.image_tag}}
    --build-arg BASE_IMAGE={{.Values.base_image}}
    --build-arg VCS_REF={{.Run.SourceControlCommit}}
    --build-arg BUILD_DATE={{.Run.Date}}
    -f docker/linux/dotnet-agent/dotnetagent.dockerfile
    .
  id: build

- cmd: $Registry/teamcity/agent:{{.Values.image_tag}} /usr/local/bin/test-image.sh
  id: smoke
  when: ["build"]

- push:
  - $Registry/teamcity/agent:{{ .Values.image_tag }}
  id: push
  when: ["smoke"]