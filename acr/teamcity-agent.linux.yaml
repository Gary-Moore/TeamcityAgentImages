version: v1.1.0
stepTimeout: 1200
steps: 
  - build: >-
     -t $Registry/teamcity/agent:{{.Values.image_tag}}
     --build-arg BASE_IMAGE={{.Values.base_image}}
     --build-arg dotnetSdkVersion={{.Values.dotnet_sdk_version}}
     --build-arg nodeVersion={{.Values.node_major}}
     --build-arg ENTRUST_INTERMEDIATE_URL={{.Values.entrust_url}}
     --build-arg ENTRUST_INTERMEDIATE_SHA256={{.Values.entrust_sha256}}
     -f docker/linux/Dockerfile
     .
    id: build

  - cmd: $Registry/teamcity/agent:{{.Values.image_tag}} /usr/local/bin/test-image.sh
    id: smoke
    when: [["build"]]

  - push:
      - $Registry/teamcity/agent:{{.Values.image_tag}}
    when: [["smoke"]]
