version: v1.1.0
stepTimeout: 1200
steps: 
 # 1) Build the image (tags the primary immutable tag)
  - build: >-
     -t $Registry/teamcity/agent:{{.Values.image_tag}}
     --build-arg BASE_IMAGE={{.Values.base_image}}
     --build-arg dotnetSdkVersion={{.Values.dotnet_sdk_version}}
     --build-arg nodeVersion={{.Values.node_major}}
     --build-arg ENTRUST_INTERMEDIATE_URL={{.Values.entrust_url}}
     --build-arg ENTRUST_INTERMEDIATE_SHA256={{.Values.entrust_sha256}}
     --build-arg VCS_REF={{.Run.SourceControlCommit}}
     --build-arg BUILD_DATE={{.Run.Date}}
     -f docker/linux/Dockerfile
     .
    id: build

 # 2) Smoke test â€” must print PDS_RUNTIME_JSON_START/END in logs
  - cmd: $Registry/teamcity/agent:{{.Values.image_tag}} /usr/local/bin/test-image.sh
    id: smoke
    when: ["build"]

 # 3) Push the primary immutable tag
  - push:
      - $Registry/teamcity/agent:{{.Values.image_tag}}
    id: push-primary
    when: ["smoke"]
# 4 ) 
  - cmd: >-
      /bin/sh -lc '
      set -e
      IMAGE_BASE=$Registry/teamcity/agent:{{.Values.image_tag}}

      if [ -n "{{.Values.alias_tag1}}" ]; then
        echo "Pushing alias tag: {{.Values.alias_tag1}}"
        docker tag "$IMAGE_BASE" "$Registry/teamcity/agent:{{.Values.alias_tag1}}"
        docker push "$Registry/teamcity/agent:{{.Values.alias_tag1}}"
      else
        echo "alias_tag1 is not set; skipping."
      fi

      if [ -n "{{.Values.alias_tag2}}" ]; then
        echo "Pushing alias tag: {{.Values.alias_tag2}}"
        docker tag "$IMAGE_BASE" "$Registry/teamcity/agent:{{.Values.alias_tag2}}"
        docker push "$Registry/teamcity/agent:{{.Values.alias_tag2}}"
      else
        echo "alias_tag2 is not set; skipping."
      fi
      '
    id: alias-push
    when: ["push-primary"]